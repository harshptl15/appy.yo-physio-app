<!--
 @Author Gregory Mah
 @Date 2025-07-14
 @class CST8319_320
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Routine</title>
    <link rel="stylesheet" href="css/routine.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <script src="/js/language.js?v=4"></script>
</head>
<body>
    <div class="overlay">
        <button class="hamburger" id="hamburgerBtn">â˜°</button>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div>
                <a class="nav-link" href="/dashboard"><span data-i18n="common.nav.dashboard">Dashboard</span></a>
                <a class="nav-link" href="/muscleGroup?fresh=1">ğŸ’ª <span data-i18n="dashboard.nav.exercises">Exercises</span></a>
                <a class="nav-link" href="/showRoutine">ğŸ“… <span data-i18n="dashboard.nav.routines">Routines</span></a>
                <a class="nav-link" href="/getAndShowFavourites">â­ <span data-i18n="dashboard.nav.favourites">Favourites</span></a>
                <a class="nav-link" href="/goals">ğŸ¯ <span data-i18n="dashboard.cta.goals">Your Goals</span></a>
                <a class="nav-link" href="/about">â„¹ï¸ <span data-i18n="dashboard.nav.about">About Us</span></a>
                <a class="nav-link" href="/settings">âš™ï¸ <span data-i18n="dashboard.nav.settings">Settings</span></a>
            </div>
            <a href="/logout" class="action-btn logout-btn" data-i18n="dashboard.logout">Logout</a>
        </aside>
        <div class="routine-card animate__animated animate__zoomIn">
            <h1 class="animate__animated animate__fadeInDown" data-i18n="routine.title">Your Exercise Routine</h1>
            <% if (workoutPlanMetadata) { %>
              <div class="routine-box" style="margin-bottom: 0.8rem;">
                <p><strong>Session plan:</strong> Warmup + <%= workoutPlanMetadata.selectedExercises %> exercises</p>
                <p>
                  Estimated duration: <%= workoutPlanMetadata.estimatedDurationMinutes %> min
                  (Preference: <%= workoutPlanMetadata.durationPreferenceMinutes %> min)
                </p>
              </div>
            <% } %>
        <!-- exerciseRoutine is an array of objects with exerciseName properties passed from the controller.
         so far this list does nothing other than dispaly the values passed by the array. -->
         <!-- select is no longer good for the view, i am replacing it with divs -->
            <!-- <select name="exerciseRoutine" id="exerciseRoutine" multiple>
                <% exerciseRoutine.forEach(function(exercise) { %>
                <option value="<%= exercise.exerciseName %>">
                    <%= exercise.exerciseName %>
                </option>
                <% }); %>
            </select>
        </div> -->
        <!-- div for showing a list of all exercises in routine. -->
         <div class="routine-list">
            <% exerciseRoutine.forEach((exercise, i) => { %>
                <div class = "routine-box <%= exercise.goal ? 'completed' : '' %>">
                    <p class="exercise-name" data-exercise-name="<%= exercise.exerciseName %>"><%= exercise.exerciseName %></p>
                    <!-- only render the following image if the exercise.goal is true 
                    and therefore this exercise has been completed-->
                    <% if (exercise.goal) { %>
                    <span class="checkmark">âœ”</span>
                        <p class="status-text" data-i18n="common.completed">Completed</p>
                    <% } %>
                </div>
            <% }) %>
         </div>
        <!-- div for buttons to control the entire routine -->
        <div class="btn-group">
            <form action="/restartRoutine" method="POST">
                <button type="submit" class="btn btn-primary" data-i18n="routine.restart">Restart Routine</button>
            </form>
                <a href="/category" class="link-btn" data-i18n="routine.newSearch">ğŸ†• New Search</a>
                <a href="/resetAndNewSearch" class="link-btn" data-i18n="exercises.resetNewSearch">â™» Reset & New Search</a>
                <a href="/getAndShowFavourites" class="link-btn" data-i18n="routine.showFavourites">â­ Show Favourites</a>
        </div>
         <!-- div for new search -->
         <!-- if all exercises in the routine are completed, show a message -->

        <% if (allExercisesCompleted) { %>
        <div class="all-exercises-completed success-alert">
            <p><span class="success-icon" aria-hidden="true">âœ“</span> <span data-i18n="routine.allCompleted">All exercises in your routine are completed!</span></p>
        </div>
        <% if (showPainFeedbackPrompt && activeWorkoutSessionId) { %>
          <div class="current-exercise pain-feedback-shell" id="painFeedbackCard">
            <h2 class="pain-feedback-title" data-i18n="routine.painCheckin.title">Post-workout pain check-in</h2>
            <p class="pain-feedback-subtitle">Help us tailor your next session by sharing how you feel.</p>
            <form id="painFeedbackForm">
              <input type="hidden" id="workoutSessionId" value="<%= activeWorkoutSessionId %>">

              <div class="form-row">
                <label for="painScore"><strong>Pain level (0-10)</strong></label>
                <div class="pain-score-display">
                  <span id="painScoreValue">0</span>
                </div>
                <input
                  type="range"
                  id="painScore"
                  min="0"
                  max="10"
                  step="1"
                  value="0"
                  required
                  list="painScoreTicks"
                  class="pain-slider"
                >
                <datalist id="painScoreTicks">
                  <option value="0"></option>
                  <option value="1"></option>
                  <option value="2"></option>
                  <option value="3"></option>
                  <option value="4"></option>
                  <option value="5"></option>
                  <option value="6"></option>
                  <option value="7"></option>
                  <option value="8"></option>
                  <option value="9"></option>
                  <option value="10"></option>
                </datalist>
                <p class="field-microcopy">0 = no pain, 10 = severe pain</p>
              </div>

              <div class="form-row">
                <label for="painTrend"><strong>Compared to before workout</strong></label>
                <div class="segmented-control" role="group" aria-label="Compared to before workout">
                  <button type="button" class="segment-btn" data-trend-value="better">Felt better</button>
                  <button type="button" class="segment-btn" data-trend-value="same">No change</button>
                  <button type="button" class="segment-btn" data-trend-value="worse">Felt worse</button>
                </div>
                <select id="painTrend" required class="visually-hidden-input">
                  <option value="">Select trend</option>
                  <option value="better">Felt better</option>
                  <option value="same">Felt the same</option>
                  <option value="worse">Felt worse</option>
                </select>
              </div>

              <div class="form-row">
                <label for="painNotes"><strong>Notes (optional)</strong></label>
                <textarea id="painNotes" rows="2" maxlength="500" placeholder="Anything else you noticed?" class="pain-notes"></textarea>
              </div>

              <p id="painFeedbackValidation" class="validation-message" aria-live="polite"></p>
              <button type="submit" class="btn btn-primary pain-submit-btn" id="painFeedbackSubmitBtn" data-i18n="routine.painCheckin.submit">Submit pain feedback</button>
              <p id="painFeedbackStatus" class="pain-status" aria-live="polite"></p>
            </form>
          </div>
        <% } else if (!painFeedbackAfterWorkoutsEnabled) { %>
          <div class="all-exercises-completed">
            <p data-i18n="routine.painCheckin.disabled">Pain check-in is disabled in your settings. Workout completed successfully.</p>
          </div>
        <% } %>
        <!-- div for buttons to control the current exercise in the routine. -->
        <% } else { %>
            <div class="current-exercise"></div>
                <!-- display info on current exercise. -->
                <h2>Now Training</h2>
                <p><strong class="exercise-name" data-exercise-name="<%= currentExercise.exerciseName %>"><%= currentExercise.exerciseName %></strong></p>
                <ul>
                    <li>ğŸ’¡ Tips: <%= currentExercise.tips %></li>
                    <li>âš  Common Mistakes: <%= currentExercise.commonMistakes %></li>
                    <li>ğŸ‹ï¸ Equipment: <%= currentExercise.equipment %></li>
                    <li>ğŸ“ Sets/Reps: <%= currentExercise.sets %> Ã— <%= currentExercise.reps %></li>
                    <li>â± Tempo/Hold Time: <%= currentExercise.tempo %></li>
                    <li>ğŸ¯ Skill Level: <%= currentExercise.skillLevel %></li>
                    <li>   Position: <%= currentExercise.position %></li>
                    <li>   Equipment: <%= currentExercise.equipment %></li>
                    <li>   Image: <%= currentExercise.image %></li>
                    <li>   Video: <%= currentExercise.video %><br></li>
                </ul>
                <div class="exercise-actions">
                    <form action="/removeExerciseFromRoutine" method="POST">
                        <input type="hidden" name="exerciseId" value="<%= currentExercise.id %>">
                        <button type="submit" class="btn btn-danger">Remove Current Exercise</button>
                    </form>
                    <form action="/markExerciseAsFinished" method="POST">
                        <input type="hidden" name="finishedExerciseId" value="<%= currentExercise.id %>">
                        <button type="submit" class="btn btn-success">Mark Exercise as Finished</button>
                    </form>
                    <form action="/addExerciseToFavouritesThenShowFavourites" method="POST">
                        <input type="hidden" name="favouriteExerciseId" value="<%= currentExercise.id %>">
                        <button type="submit" class="btn btn-secondary">Add to Favourites</button>
                    </form>
                </div>
            </div>
        <% } %>
    </div>
    <script>
        const hamburgerBtn = document.getElementById("hamburgerBtn");
        const sidebar = document.getElementById("sidebar");

        hamburgerBtn.addEventListener("click", () => {
        sidebar.classList.toggle("open");
        });

        const painFeedbackForm = document.getElementById('painFeedbackForm');
        if (painFeedbackForm) {
          const painScoreInput = document.getElementById('painScore');
          const painScoreValue = document.getElementById('painScoreValue');
          const painTrendSelect = document.getElementById('painTrend');
          const trendButtons = document.querySelectorAll('.segment-btn');
          const validationEl = document.getElementById('painFeedbackValidation');
          const submitBtn = document.getElementById('painFeedbackSubmitBtn');

          const updateSliderVisualState = () => {
            const value = Number(painScoreInput.value);
            painScoreValue.textContent = String(value);
            painScoreInput.style.setProperty('--score', value);
          };

          trendButtons.forEach((button) => {
            button.addEventListener('click', () => {
              painTrendSelect.value = button.dataset.trendValue || '';
              trendButtons.forEach((item) => item.classList.remove('selected'));
              button.classList.add('selected');
            });
          });

          painScoreInput.addEventListener('input', () => {
            updateSliderVisualState();
            validationEl.textContent = '';
          });

          painTrendSelect.addEventListener('change', () => {
            validationEl.textContent = '';
          });

          const applyDynamicTranslations = () => {
            if (!window.PhysioLanguage || typeof window.PhysioLanguage.translateDynamic !== 'function') return;
            const language = window.PhysioLanguage.getLanguagePreference();
            document.querySelectorAll('.exercise-name[data-exercise-name]').forEach((el) => {
              const raw = el.getAttribute('data-exercise-name');
              el.textContent = window.PhysioLanguage.translateDynamic('exercise', raw, language);
            });
          };

          applyDynamicTranslations();
          window.addEventListener('physio-language-changed', applyDynamicTranslations);

          updateSliderVisualState();

          painFeedbackForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const statusEl = document.getElementById('painFeedbackStatus');
            const painScore = Number(document.getElementById('painScore').value);
            const trend = document.getElementById('painTrend').value;
            validationEl.textContent = '';
            statusEl.textContent = '';

            if (!Number.isInteger(painScore) || painScore < 0 || painScore > 10) {
              validationEl.textContent = 'Please select a pain score between 0 and 10.';
              validationEl.style.color = '#f8a5a5';
              return;
            }

            if (!trend) {
              validationEl.textContent = 'Please choose how you felt compared to before workout.';
              validationEl.style.color = '#f8a5a5';
              return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';
            statusEl.textContent = 'Saving...';
            statusEl.style.color = '#1f3a5a';

            const payload = {
              workoutSessionId: Number(document.getElementById('workoutSessionId').value),
              painScore,
              trend,
              notes: document.getElementById('painNotes').value.trim()
            };

            try {
              const response = await fetch('/api/workouts/pain-feedback', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
              });
              const result = await response.json();

              if (!response.ok) {
                throw new Error(result.error || 'Failed to save pain feedback.');
              }

              statusEl.textContent = 'Saved. Next workout progression has been updated.';
              statusEl.style.color = '#1e7b4f';
              setTimeout(() => window.location.reload(), 600);
            } catch (error) {
              statusEl.textContent = error.message || 'Failed to save pain feedback.';
              statusEl.style.color = '#9b1c1c';
            } finally {
              submitBtn.disabled = false;
              submitBtn.textContent = 'Submit pain feedback';
            }
          });
        }
    </script>
</body>
</html>
