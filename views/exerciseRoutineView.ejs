<!--
 @Author Gregory Mah
 @Date 2025-07-14
 @class CST8319_320
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Routine</title>
    <link rel="stylesheet" href="css/routine.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
</head>
<body>
    <div class="overlay">
        <button class="hamburger" id="hamburgerBtn">â˜°</button>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div>
                <a class="nav-link" href="/dashboard">Dashboard</a>
                <a class="nav-link" href="/muscleGroup?fresh=1">ğŸ’ª Exercises</a>
                <a class="nav-link" href="/showRoutine">ğŸ“… Routines</a>
                <a class="nav-link" href="/getAndShowFavourites">â­ Favourites</a>
                <a class="nav-link" href="/goals">ğŸ¯ Your Goals</a>
                <a class="nav-link" href="/about">â„¹ï¸ About Us</a>
                <a class="nav-link" href="/settings">âš™ï¸ Settings</a>
            </div>
            <a href="/logout" class="action-btn logout-btn">Logout</a>
        </aside>
        <div class="routine-card animate__animated animate__zoomIn">
            <h1 class="animate__animated animate__fadeInDown">Your Exercise Routine</h1>
            <% if (workoutPlanMetadata) { %>
              <div class="routine-box" style="margin-bottom: 0.8rem;">
                <p><strong>Session plan:</strong> Warmup + <%= workoutPlanMetadata.selectedExercises %> exercises</p>
                <p>
                  Estimated duration: <%= workoutPlanMetadata.estimatedDurationMinutes %> min
                  (Preference: <%= workoutPlanMetadata.durationPreferenceMinutes %> min)
                </p>
              </div>
            <% } %>
        <!-- exerciseRoutine is an array of objects with exerciseName properties passed from the controller.
         so far this list does nothing other than dispaly the values passed by the array. -->
         <!-- select is no longer good for the view, i am replacing it with divs -->
            <!-- <select name="exerciseRoutine" id="exerciseRoutine" multiple>
                <% exerciseRoutine.forEach(function(exercise) { %>
                <option value="<%= exercise.exerciseName %>">
                    <%= exercise.exerciseName %>
                </option>
                <% }); %>
            </select>
        </div> -->
        <!-- div for showing a list of all exercises in routine. -->
         <div class="routine-list">
            <% exerciseRoutine.forEach((exercise, i) => { %>
                <div class = "routine-box <%= exercise.goal ? 'completed' : '' %>">
                    <p><%= exercise.exerciseName %></p>
                    <!-- only render the following image if the exercise.goal is true 
                    and therefore this exercise has been completed-->
                    <% if (exercise.goal) { %>
                    <span class="checkmark">âœ”</span>
                        <p class="status-text">Completed</p>
                    <% } %>
                </div>
            <% }) %>
         </div>
        <!-- div for buttons to control the entire routine -->
        <div class="btn-group">
            <form action="/restartRoutine" method="POST">
                <button type="submit" class="btn btn-primary">Restart Routine</button>
            </form>
                <a href="/category" class="link-btn">ğŸ†• New Search</a>
                <a href="/resetAndNewSearch" class="link-btn">â™» Reset & New Search</a>
                <a href="/getAndShowFavourites" class="link-btn">â­ Show Favourites</a>
        </div>
         <!-- div for new search -->
         <!-- if all exercises in the routine are completed, show a message -->

        <% if (allExercisesCompleted) { %>
        <div class="all-exercises-completed">
            <p>ğŸ‰ All exercises in your routine are completed!</p>
        </div>
        <% if (showPainFeedbackPrompt && activeWorkoutSessionId) { %>
          <div class="current-exercise" id="painFeedbackCard">
            <h2>Post-workout pain check-in</h2>
            <p>Help us tailor your next session by sharing how you feel.</p>
            <form id="painFeedbackForm">
              <input type="hidden" id="workoutSessionId" value="<%= activeWorkoutSessionId %>">
              <label for="painScore"><strong>Pain level (0-10)</strong></label>
              <input type="number" id="painScore" min="0" max="10" required style="width: 100%; margin: 0.4rem 0 0.8rem; padding: 0.45rem;">

              <label for="painTrend"><strong>Compared to before workout</strong></label>
              <select id="painTrend" required style="width: 100%; margin: 0.4rem 0 0.8rem; padding: 0.45rem;">
                <option value="">Select trend</option>
                <option value="better">Felt better</option>
                <option value="same">Felt the same</option>
                <option value="worse">Felt worse</option>
              </select>

              <label for="painNotes"><strong>Notes (optional)</strong></label>
              <textarea id="painNotes" rows="3" maxlength="500" style="width: 100%; margin: 0.4rem 0 0.8rem; padding: 0.45rem;"></textarea>

              <button type="submit" class="btn btn-primary">Submit pain feedback</button>
              <p id="painFeedbackStatus" style="margin-top: 0.6rem;"></p>
            </form>
          </div>
        <% } else if (!painFeedbackAfterWorkoutsEnabled) { %>
          <div class="all-exercises-completed">
            <p>Pain check-in is disabled in your settings. Workout completed successfully.</p>
          </div>
        <% } %>
        <!-- div for buttons to control the current exercise in the routine. -->
        <% } else { %>
            <div class="current-exercise"></div>
                <!-- display info on current exercise. -->
                <h2>Now Training</h2>
                <p><strong><%= currentExercise.exerciseName %></strong></p>
                <ul>
                    <li>ğŸ’¡ Tips: <%= currentExercise.tips %></li>
                    <li>âš  Common Mistakes: <%= currentExercise.commonMistakes %></li>
                    <li>ğŸ‹ï¸ Equipment: <%= currentExercise.equipment %></li>
                    <li>ğŸ“ Sets/Reps: <%= currentExercise.sets %> Ã— <%= currentExercise.reps %></li>
                    <li>â± Tempo/Hold Time: <%= currentExercise.tempo %></li>
                    <li>ğŸ¯ Skill Level: <%= currentExercise.skillLevel %></li>
                    <li>   Position: <%= currentExercise.position %></li>
                    <li>   Equipment: <%= currentExercise.equipment %></li>
                    <li>   Image: <%= currentExercise.image %></li>
                    <li>   Video: <%= currentExercise.video %><br></li>
                </ul>
                <div class="exercise-actions">
                    <form action="/removeExerciseFromRoutine" method="POST">
                        <input type="hidden" name="exerciseId" value="<%= currentExercise.id %>">
                        <button type="submit" class="btn btn-danger">Remove Current Exercise</button>
                    </form>
                    <form action="/markExerciseAsFinished" method="POST">
                        <input type="hidden" name="finishedExerciseId" value="<%= currentExercise.id %>">
                        <button type="submit" class="btn btn-success">Mark Exercise as Finished</button>
                    </form>
                    <form action="/addExerciseToFavouritesThenShowFavourites" method="POST">
                        <input type="hidden" name="favouriteExerciseId" value="<%= currentExercise.id %>">
                        <button type="submit" class="btn btn-secondary">Add to Favourites</button>
                    </form>
                </div>
            </div>
        <% } %>
    </div>
    <script>
        const hamburgerBtn = document.getElementById("hamburgerBtn");
        const sidebar = document.getElementById("sidebar");

        hamburgerBtn.addEventListener("click", () => {
        sidebar.classList.toggle("open");
        });

        const painFeedbackForm = document.getElementById('painFeedbackForm');
        if (painFeedbackForm) {
          painFeedbackForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const statusEl = document.getElementById('painFeedbackStatus');
            statusEl.textContent = 'Saving...';
            statusEl.style.color = '#1f3a5a';

            const payload = {
              workoutSessionId: Number(document.getElementById('workoutSessionId').value),
              painScore: Number(document.getElementById('painScore').value),
              trend: document.getElementById('painTrend').value,
              notes: document.getElementById('painNotes').value.trim()
            };

            try {
              const response = await fetch('/api/workouts/pain-feedback', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
              });
              const result = await response.json();

              if (!response.ok) {
                throw new Error(result.error || 'Failed to save pain feedback.');
              }

              statusEl.textContent = 'Saved. Next workout progression has been updated.';
              statusEl.style.color = '#1e7b4f';
              setTimeout(() => window.location.reload(), 600);
            } catch (error) {
              statusEl.textContent = error.message || 'Failed to save pain feedback.';
              statusEl.style.color = '#9b1c1c';
            }
          });
        }
    </script>
</body>
</html>
