<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Verify 2FA | PhysioApp</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/verify2fa.css">
</head>
<body class="auth-bg">
  <div class="overlay">
    <form class="form-card" action="/twofa/verify" method="POST">
      <p class="eyebrow">Two-Factor Check</p>
      <h1>Verify Sign-In</h1>
      <p class="helper">Open your authenticator app and enter the current code.</p>

        <% if (typeof error !== 'undefined' && error) { %>
          <div class="error-msg"><%= error %></div>
        <% } %>

      <label for="token" class="token-label">6-digit code</label>
      <input
        type="text"
        id="token"
        name="token"
        class="form-control"
        placeholder="123456"
        pattern="[0-9]{6}"
        maxlength="6"
        inputmode="numeric"
        required
        autofocus
      >

      <button type="submit">Verify</button>
      <a href="/login" class="secondary-link">Back to login</a>
    </form>
  </div>
  <script>
    (function () {
      const hidden = document.getElementById('token');
      const btn = document.getElementById('submitBtn');
      const boxes = Array.from(document.querySelectorAll('.code-box'));
      const setDisabled = () => {
        if (!hidden || !btn) return;
        hidden.value = boxes.map((b) => b.value).join('');
        btn.disabled = hidden.value.length !== 6;
      };
      boxes.forEach((box, idx) => {
        box.addEventListener('input', (e) => {
          const value = e.target.value.replace(/[^\d]/g, '');
          e.target.value = value;
          if (value && idx < boxes.length - 1) {
            boxes[idx + 1].focus();
          }
          setDisabled();
        });
        box.addEventListener('keydown', (e) => {
          if (e.key === 'Backspace' && !box.value && idx > 0) {
            boxes[idx - 1].focus();
          }
        });
      });
      if (boxes[0]) {
        boxes[0].addEventListener('paste', (e) => {
          const text = (e.clipboardData || window.clipboardData).getData('text');
          const digits = text.replace(/[^\d]/g, '').slice(0, 6).split('');
          if (digits.length) {
            e.preventDefault();
            digits.forEach((d, i) => {
              if (boxes[i]) boxes[i].value = d;
            });
            boxes[Math.min(digits.length, 5)].focus();
            setDisabled();
          }
        });
      }
      setDisabled();

      const success = document.querySelector('.success-state');
      if (success) {
        setTimeout(() => {
          window.location.href = '/dashboard';
        }, 900);
      }
    })();
  </script>
</body>
</html>
