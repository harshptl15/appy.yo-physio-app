<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Verify Two‑Factor Authentication</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <link rel="stylesheet" href="/css/verify2fa.css">
</head>
<body class="auth-bg">
  <div class="overlay">
    <div class="form-card animate__animated animate__fadeInDown <%= (typeof success !== 'undefined' && success) ? 'success-mode' : '' %>">
      <% if (typeof success !== 'undefined' && success) { %>
        <div class="success-state">
          <div class="success-icon">✓</div>
          <h1>Verified</h1>
          <p class="helper-text">Welcome back.</p>
        </div>
      <% } else { %>
      <form action="/twofa/verify" method="POST">
        <h1>Secure Your Account</h1>

        <% if (typeof error !== 'undefined' && error) { %>
          <div class="error-msg"><%= error %></div>
        <% } %>

        <div class="helper-text">Enter the 6‑digit code from your app.</div>
        <div id="token-help" class="helper-text helper-sub">Codes refresh every 30 seconds.</div>
        <label for="token" class="sr-only">6‑digit code</label>
        <input type="hidden" id="token" name="token" required>
        <div class="code-inputs" aria-describedby="token-help">
          <% for (let i = 1; i <= 6; i++) { %>
            <input
              type="text"
              inputmode="numeric"
              maxlength="1"
              pattern="[0-9]"
              class="code-box"
              aria-label="Digit <%= i %>"
              <%= i === 1 ? 'autofocus autocomplete="one-time-code"' : '' %>
            >
          <% } %>
        </div>

        <div class="actions">
          <button id="submitBtn" class="primary-btn" type="submit" disabled>Verify</button>
          <a class="secondary-btn" href="/login">Not now</a>
        </div>

      </form>
      <% } %>
    </div>
  </div>
  <script>
    (function () {
      const hidden = document.getElementById('token');
      const btn = document.getElementById('submitBtn');
      const boxes = Array.from(document.querySelectorAll('.code-box'));
      const setDisabled = () => {
        if (!hidden || !btn) return;
        hidden.value = boxes.map((b) => b.value).join('');
        btn.disabled = hidden.value.length !== 6;
      };
      boxes.forEach((box, idx) => {
        box.addEventListener('input', (e) => {
          const value = e.target.value.replace(/[^\d]/g, '');
          e.target.value = value;
          if (value && idx < boxes.length - 1) {
            boxes[idx + 1].focus();
          }
          setDisabled();
        });
        box.addEventListener('keydown', (e) => {
          if (e.key === 'Backspace' && !box.value && idx > 0) {
            boxes[idx - 1].focus();
          }
        });
      });
      if (boxes[0]) {
        boxes[0].addEventListener('paste', (e) => {
          const text = (e.clipboardData || window.clipboardData).getData('text');
          const digits = text.replace(/[^\d]/g, '').slice(0, 6).split('');
          if (digits.length) {
            e.preventDefault();
            digits.forEach((d, i) => {
              if (boxes[i]) boxes[i].value = d;
            });
            boxes[Math.min(digits.length, 5)].focus();
            setDisabled();
          }
        });
      }
      setDisabled();

      const success = document.querySelector('.success-state');
      if (success) {
        setTimeout(() => {
          window.location.href = '/dashboard';
        }, 900);
      }
    })();
  </script>
</body>
</html>
