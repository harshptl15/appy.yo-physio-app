<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Set Up 2FA | PhysioApp</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/setup2fa.css">
</head>
<body class="auth-bg">
  <div class="overlay">
    <form class="form-card" action="/twofa/setup" method="POST">
      <p class="eyebrow">Security Upgrade</p>
      <h1>Set Up Two-Factor Authentication</h1>
      <p class="helper">
        Connect your authenticator app to secure
        <strong><%= username || 'your account' %></strong>.
      </p>

        <% if (typeof error !== 'undefined' && error) { %>
          <div class="error-msg"><%= error %></div>
        <% } %>

        <div class="qr-box">
          <% if (qrCodeUrl) { %>
            <img src="<%= qrCodeUrl %>" alt="2FA QR Code">
          <% } else { %>
            <div class="qr-fallback">QR unavailable</div>
          <% } %>
        </div>
        <div class="helper-text helper-sub">Scan with Google Authenticator, Authy, or Microsoft Authenticator.</div>

        <div class="manual-key">
          <div class="manual-key-label">Can’t scan? Enter this key manually:</div>
          <div class="manual-key-row">
            <code id="manualKey"><%= typeof manualKey !== 'undefined' ? manualKey : '' %></code>
            <button type="button" class="copy-btn" data-copy="#manualKey">Copy</button>
          </div>
        </div>

        <label for="token">Enter the 6‑digit code from your app</label>
        <input type="hidden" id="token" name="token" required>
        <div class="code-inputs" aria-describedby="token-help">
          <% for (let i = 1; i <= 6; i++) { %>
            <input
              type="text"
              inputmode="numeric"
              maxlength="1"
              pattern="[0-9]"
              class="code-box"
              aria-label="Digit <%= i %>"
              <%= i === 1 ? 'autofocus autocomplete="one-time-code"' : '' %>
            >
          <% } %>
        </div>
        <div id="token-help" class="helper-text helper-sub">Codes refresh every 30 seconds.</div>

      <% if (qrCodeUrl) { %>
        <p>1. Scan this QR code in Google Authenticator, Authy, or 1Password.</p>
        <div class="qr-box">
          <img src="<%= qrCodeUrl %>" alt="2FA QR code">
        </div>
      <% } %>

      <div class="manual-key">
        <p>2. If scanning fails, enter this key manually:</p>
        <code><%= manualKey %></code>
      </div>

      <label for="token">3. Enter the current 6-digit code</label>
      <input
        type="text"
        id="token"
        name="token"
        class="form-control"
        placeholder="123456"
        pattern="[0-9]{6}"
        maxlength="6"
        inputmode="numeric"
        required
        autofocus
      >

      <button type="submit">Enable 2FA</button>
      <a href="/settings" class="secondary-link">Cancel and return to settings</a>
    </form>
  </div>
  <script>
    (function () {
      const hidden = document.getElementById('token');
      const btn = document.getElementById('submitBtn');
      const copyBtn = document.querySelector('.copy-btn');
      const boxes = Array.from(document.querySelectorAll('.code-box'));
      const setDisabled = () => {
        if (!hidden || !btn) return;
        hidden.value = boxes.map((b) => b.value).join('');
        btn.disabled = hidden.value.length !== 6;
      };
      boxes.forEach((box, idx) => {
        box.addEventListener('input', (e) => {
          const value = e.target.value.replace(/[^\d]/g, '');
          e.target.value = value;
          if (value && idx < boxes.length - 1) {
            boxes[idx + 1].focus();
          }
          setDisabled();
        });
        box.addEventListener('keydown', (e) => {
          if (e.key === 'Backspace' && !box.value && idx > 0) {
            boxes[idx - 1].focus();
          }
        });
      });
      if (boxes[0]) {
        boxes[0].addEventListener('paste', (e) => {
          const text = (e.clipboardData || window.clipboardData).getData('text');
          const digits = text.replace(/[^\d]/g, '').slice(0, 6).split('');
          if (digits.length) {
            e.preventDefault();
            digits.forEach((d, i) => {
              if (boxes[i]) boxes[i].value = d;
            });
            boxes[Math.min(digits.length, 5)].focus();
            setDisabled();
          }
        });
      }
      setDisabled();

      if (copyBtn) {
        copyBtn.addEventListener('click', async () => {
          const target = document.querySelector(copyBtn.dataset.copy);
          if (!target) return;
          try {
            await navigator.clipboard.writeText(target.textContent.trim());
            copyBtn.textContent = 'Copied';
            setTimeout(() => (copyBtn.textContent = 'Copy'), 1200);
          } catch (_) {
            copyBtn.textContent = 'Copy failed';
            setTimeout(() => (copyBtn.textContent = 'Copy'), 1200);
          }
        });
      }

      const success = document.querySelector('.success-state');
      if (success) {
        setTimeout(() => {
          window.location.href = '/dashboard';
        }, 1200);
      }
    })();
  </script>
</body>
</html>
